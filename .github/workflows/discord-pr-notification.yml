name: Discord PR Notification

on:
  pull_request:
    types: [opened, closed, reopened]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  discord-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        uses: actions/github-script@v6
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          CHANNEL_ID: '1351796500279197757' # pr-ë¦¬ë·°-ìš”ì²­ ì±„ë„
          ROLE_ID: '1347541606927962152' # í”„ë¡ íŠ¸ì—”ë“œ ì—­í• 
        with:
          script: |
            const https = require('https');

            const token = process.env.DISCORD_BOT_TOKEN;
            const channelId = process.env.CHANNEL_ID;
            const roleId = process.env.ROLE_ID;

            // ì»¨í…ìŠ¤íŠ¸ì—ì„œ PR ì •ë³´ ì¶”ì¶œ
            const pr = context.payload.pull_request || context.payload.issue;
            const isPr = !!pr.pull_request_url || !!pr.html_url.includes('/pull/');

            if (!isPr) {
              console.log('Not a PR event.');
              return;
            }

            const eventName = context.eventName;
            const action = context.payload.action;
            const prUrl = pr.html_url;
            const prTitle = pr.title;
            const sender = context.payload.sender.login;

            // ë©”ì‹œì§€ ë‚´ìš© êµ¬ì„±
            let content = '';
            let isNew = false;

            if (eventName === 'pull_request' && action === 'opened') {
              isNew = true;
              content = `<@&${roleId}> ğŸ“¢ **ìƒˆë¡œìš´ PRì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!**\n\n**[${prTitle}](${prUrl})**\nBy: ${sender}`;
            } else if (eventName === 'pull_request' && action === 'closed') {
              const merged = context.payload.pull_request.merged;
              content = merged ? `âœ… **PRì´ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.**` : `â›” **PRì´ ë‹«í˜”ìŠµë‹ˆë‹¤.**`;
            } else if (eventName === 'issue_comment' || eventName === 'pull_request_review') {
               content = `ğŸ’¬ **${sender}**ë‹˜ì´ ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¼ìŠµë‹ˆë‹¤.\n> ${context.payload.comment ? context.payload.comment.body.slice(0, 50) + '...' : 'ë¦¬ë·° ì œì¶œë¨'}`;
            } else {
               return; // ì²˜ë¦¬í•˜ì§€ ì•ŠëŠ” ì´ë²¤íŠ¸
            }

            // Discord API ìš”ì²­ í•¨ìˆ˜
            function request(method, path, body) {
              return new Promise((resolve, reject) => {
                const req = https.request({
                  hostname: 'discord.com',
                  path: '/api/v10' + path,
                  method,
                  headers: {
                    'Authorization': `Bot ${token}`,
                    'Content-Type': 'application/json'
                  }
                }, res => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => resolve(JSON.parse(data)));
                });
                req.on('error', reject);
                if (body) req.write(JSON.stringify(body));
                req.end();
              });
            }

            async function main() {
              // 1. ìƒˆ PRì´ë©´ ê·¸ëƒ¥ ë©”ì‹œì§€ ì „ì†¡
              if (isNew) {
                await request('POST', `/channels/${channelId}/messages`, { content });
                return;
              }

              // 2. ê¸°ì¡´ PRì´ë©´ ì›ë³¸ ë©”ì‹œì§€ë¥¼ ì°¾ì•„ì„œ ìŠ¤ë ˆë“œ(ë‹µê¸€) ë‹¬ê¸°
              // ìµœê·¼ ë©”ì‹œì§€ 50ê°œë¥¼ ê°€ì ¸ì™€ì„œ í•´ë‹¹ PR ë§í¬ê°€ ìˆëŠ” ë´‡ ë©”ì‹œì§€ë¥¼ ì°¾ìŒ
              const messages = await request('GET', `/channels/${channelId}/messages?limit=50`);
              
              const originalMsg = messages.find(m => 
                m.author.bot && 
                m.content.includes(prUrl)
              );

              if (originalMsg) {
                // ì›ë³¸ ë©”ì‹œì§€ì— ë‹µê¸€ ë‹¬ê¸° (ìŠ¤ë ˆë“œì²˜ëŸ¼ ë³´ì„)
                await request('POST', `/channels/${channelId}/messages`, {
                  content,
                  message_reference: { message_id: originalMsg.id }
                });
              } else {
                // ì›ë³¸ì„ ëª» ì°¾ìœ¼ë©´ ê·¸ëƒ¥ ìƒˆ ë©”ì‹œì§€ë¡œ ì „ì†¡ (ë§í¬ í¬í•¨í•´ì„œ ë§¥ë½ ìœ ì§€)
                await request('POST', `/channels/${channelId}/messages`, { 
                  content: `[PR Link](${prUrl})\n${content}` 
                });
              }
            }

            await main();
