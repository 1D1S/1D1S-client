name: Notion Sync

on:
  pull_request:
    types: [opened, closed, reopened, edited]

jobs:
  update-notion:
    runs-on: ubuntu-latest
    steps:
      - name: Update Notion Status
        uses: actions/github-script@v6
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: '2f841807241280379e84f43daa636edb' # 노션 DB ID
        with:
          script: |
            const https = require('https');

            const NOTION_API_KEY = process.env.NOTION_API_KEY;
            const DATABASE_ID = process.env.NOTION_DATABASE_ID;

            const pr = context.payload.pull_request;
            const title = pr.title;
            const body = pr.body || "";

            // 1. ODS- 숫자 찾기 (제목 또는 본문에서)
            // 예: "feat: [ODS-12] 로그인 기능" -> 12 추출
            const regex = /ODS-(\d+)/i;
            const match = title.match(regex) || body.match(regex);

            if (!match) {
              console.log("No Notion ID (ODS-xxx) found in PR title or body.");
              return;
            }

            const issueId = parseInt(match[1], 10); // 숫자만 추출 (예: 12)
            console.log(`Found Notion Issue ID: ODS-${issueId}`);

            // 2. 변경할 상태 결정
            let newStatus = null;
            if (context.payload.action === 'opened' || context.payload.action === 'reopened') {
               newStatus = '진행중';
            } else if (context.payload.action === 'closed' && pr.merged) {
               newStatus = '완료';
            }

            if (!newStatus) {
               console.log("No status change needed for this action.");
               return;
            }

            // Notion API 호출 함수
            function notionRequest(method, path, body) {
              return new Promise((resolve, reject) => {
                const req = https.request({
                  hostname: 'api.notion.com',
                  path: '/v1' + path,
                  method,
                  headers: {
                    'Authorization': `Bearer ${NOTION_API_KEY}`,
                    'Notion-Version': '2022-06-28',
                    'Content-Type': 'application/json'
                  }
                }, res => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => resolve(JSON.parse(data)));
                });
                req.on('error', reject);
                if (body) req.write(JSON.stringify(body));
                req.end();
              });
            }

            async function main() {
              // 3. 해당 ID(숫자)를 가진 페이지 찾기
              // Notion의 Unique ID 속성은 쿼리로 검색해야 함
              console.log("Searching for page in Notion...");
              
              const queryRes = await notionRequest('POST', `/databases/${DATABASE_ID}/query`, {
                filter: {
                  property: "ID",
                  unique_id: {
                    equals: issueId
                  }
                }
              });

              if (!queryRes.results || queryRes.results.length === 0) {
                 console.log(`Page not found for ODS-${issueId}`);
                 return;
              }

              const pageId = queryRes.results[0].id;
              console.log(`Found Page: ${pageId}. Updating status to '${newStatus}'...`);

              // 4. 상태 업데이트
              const updateRes = await notionRequest('PATCH', `/pages/${pageId}`, {
                properties: {
                  "상태": { // 속성 이름
                    status: {
                      name: newStatus // 변경할 값 (진행중 / 완료)
                    }
                  }
                }
              });
              
              if (updateRes.object === 'error') {
                 console.error("Failed to update:", updateRes);
                 core.setFailed(updateRes.message);
              } else {
                 console.log("Successfully updated Notion page status!");
              }
            }

            await main();
